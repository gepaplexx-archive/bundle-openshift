apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test-1"
  namespace: helm-ci-test
  annotations:
    "helm.sh/hook": test-success
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
    - name: gp-dev-role-test-3
      image: openshift/origin-cli
      imagePullPolicy: IfNotPresent
      resources:
        limits:
          memory: 500Mi
          cpu: 300m
        requests:
          memory: 200Mi
          cpu: 100m
      env:
      - name: CI_USER_TOKEN
        valueFrom:
          secretKeyRef:
            name: helm-test-secret
            key: token
      - name: APISERVER
        valueFrom:
          secretKeyRef:
            name: helm-test-secret
            key: apiserver      
      command: ["/bin/bash", "-c"]
      args: 
        - oc login --token $CI_USER_TOKEN --server=$APISERVER --insecure-skip-tls-verify=true;
          oc project helm-ci-test;
          oc get networkpolicy allow-same-namespace -n helm-ci-test;
          if [[ 0 -ne $? ]]; then exit 1;fi;
          oc delete networkpolicy allow-same-namespace;
          if [[ 0 -eq $? ]]; then exit 1;fi;
          oc new-project test;
          if [[ 0 -eq $? ]]; then exit 1;fi;
          oc patch resourcequota cpu-memory-quota -n helm-ci-test -p '{"spec":{"hard:{"limits.cpu":"4"}}}';
          if [[ 0 -eq $? ]]; then exit 1;fi;
          oc adm policy add-role-to-user edit system:serviceaccount:gp-dev-role:helm-ci-test-user -n helm-ci-test;
          if [[ 0 -eq $? ]]; then exit 1;fi;
      resources:
        limits:
          memory: 500Mi
          cpu: 300m
        requests:
          memory: 200Mi
          cpu: 100m          
  restartPolicy: Never