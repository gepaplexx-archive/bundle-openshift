{{ if or .Values.git.enable .Values.google.enable .Values.htpasswd.enable }}
apiVersion: redhatcop.redhat.io/v1alpha1
kind: ResourceLocker
metadata:
  name: patch-identity-prov
spec:
  serviceAccountRef:
    name: resource-locker-sa
  patches:
    - targetObjectRef:
        apiVersion: config.openshift.io/v1
        kind: OAuth
        name: cluster
      patchTemplate: |
        spec:
          identityProviders:
{{- if .Values.git.enable }}
            - name: Gepaplexx
              mappingMethod: claim
              type: GitHub
              github:
                clientID: {{`{{ (index . 0).data.clientId | b64dec }}`}}
                organizations: {{`{{ (index . 0).data.restrOrgs | b64dec }}`}}
                clientSecret:
                  name: {{ .Values.git.k8secretName }}
{{- end }} {{ if .Values.google.enable }}
            - name: Gepardec
              mappingMethod: claim
              type: Google
              google:
                {{- if not .Values.git.enable }}
                clientID: {{`{{ (index . 0).data.clientId | b64dec }}`}}
                hostedDomain: {{`{{ (index . 0).data.restrDomain | b64dec }}`}}
                {{- else }}
                clientID: {{`{{ (index . 1).data.clientId | b64dec }}`}}
                hostedDomain: {{`{{ (index . 1).data.restrDomain | b64dec }}`}}
                {{- end }}
                clientSecret:
                  name: {{ .Values.google.k8secretName }}
{{- end }} {{ if .Values.htpasswd.enable }}
            - name: HTPasswd
              mappingMethod: claim
              type: HTPasswd
              htpasswd:
                fileData:
                  name: {{ .Values.htpasswd.k8secretName }}
{{- end }}
      patchType: application/merge-patch+json
      id: patch-identity-prov
{{- if or .Values.git.enable .Values.google.enable }}
      sourceObjectRefs:
  {{- if .Values.git.enable }}
        - apiVersion: v1
          kind: Secret
          name: github-oauth-secret
          namespace: openshift-config
  {{- end }} {{ if .Values.google.enable }}
        - apiVersion: v1
          kind: Secret
          name: google-oauth-secret
          namespace: openshift-config
  {{ end }}
{{ end }}
{{ end }}